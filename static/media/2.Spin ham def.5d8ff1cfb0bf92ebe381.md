# 격자의 스핀 지정
## 구상
* 구현해야 할 상호 작용
***
>1. 같은 레이어 내의 대칭적 상호작용
>2. 레이어간 상호작용
***

* 스핀을 지정하기 위해서는 각 지점들에 대한 거리 계산이 필수적
* 격자 배열을 행렬 연산을 통해서 i,j 점간 거리를 i,j에 저장하면 좋을 듯
```py
import numpy as np

def distance_for_lattice(lat1, lat2):
    diff = lat1[:, :, np.newaxis] - lat2[:, np.newaxis, :]
    distances = np.linalg.norm(diff, axis=0)
    return distances
```
## 브로드캐스팅 
* 두 배열간 차원에 차이가 나면 강제로 맞춰주는 기능
* np.newaxis를 통해 기존 배열의 차원을 강제로 늘리면 latt1의 [3,N1] 배열이 [3,N1,1]이 되고 latt2의 [3,N2]를 [3,1,N2]로 늘릴 수 있음  
이때 둘을 연산하면 자동으로 [3,N1,N2] 배열로 변하고 빈 자리는 강제로 기존 요소를 그대로 가져와서 채움
* 바둑판식으로 생각하면 이해가 쉽다.
* 결과적으로 ij 자리엔 latt1[:,i] - latt2[:,j] 가 오게 되는 셈

```py
print(distance_for_lattice(moire.r1,moire.r2))

# 실행 결과
[[1.         3.16227766 6.08276253]
 [2.23606798 1.41421356 4.12310563]
 [4.12310563 1.41421356 2.23606798]
 [6.08276253 3.16227766 1.        ]]
```
### 예시
* 기본 유닛셀 안에서 사이트들간의 상대 벡터 배열 dR이 존재한다. (3xNxN) 사이즈
* FBZ에서 자기 자신과 주변 유닛셀까지의 기본 벡터를 표현한 배열 T가 존재한다. (3xNu) 사이즈
* 주변 유닛과 FBZ의 상대 벡터를 표현 한 벡터 dRT를 만들고 싶다면? 

1. 결과물은 (3xNxNxNu)의 형태가 되어야 함
2. np.array에서 인덱싱은 역순으로 되어야함
3. dR의 경우 3xNxN이므로 Nu가 들어올 맨 마지막에 브로드 캐스팅을 위한 새로운 차원 만들어 주어야함
4. T의 경우 (3xNu)이므로 중간에 NxN이 들어올 자리를 만들어 주어야함
5. 따라서 dR -> [np.newaxis, :, :, :]으로 사용, T -> [:, np.newaxis, np.newaxis, :]으로 사용
6. 이후 차원 증가를 대비해서 ellipsis로 변경해서 사용

```py
# 예시 dR (3 x N x N 크기)
dR = np.array([[[1, 2, 3], [4, 5, 6], [4, 5, 6]],
               [[1, 1, 1], [2, 2, 2], [4, 5, 6]],
               [[0, 0, 0], [1, 1, 1], [4, 5, 6]]])

# 예시 T (3 x Nu 크기)
T = np.array([[-1, -2, -3], [-4, -5, -6], [-1, -1, -1], [1,2,3]])

# dR의 모든 요소에서 T의 요소를 각각 더하고싶다면?
dRT = dR[np.newaxis, ...] + T[..., np.newaxis, np.newaxis, :]

print(dRT)

# 결과
[[[[ 0  0  0]
   [ 3  3  3]
   [ 3  3  3]]

  [[ 0 -1 -2]
   [ 1  0 -1]
   [ 3  3  3]]

  [[-1 -2 -3]
   [ 0 -1 -2]
   [ 3  3  3]]]


 [[[-3 -3 -3]
   [ 0  0  0]
   [ 0  0  0]]

  [[-3 -4 -5]
   [-2 -3 -4]
   [ 0  0  0]]

  [[-4 -5 -6]
   [-3 -4 -5]
   [ 0  0  0]]]


 [[[ 0  1  2]
   [ 3  4  5]
   [ 3  4  5]]

  [[ 0  0  0]
   [ 1  1  1]
   [ 3  4  5]]

  [[-1 -1 -1]
   [ 0  0  0]
   [ 3  4  5]]]]
```
